- name: Install docker
  block:
    - name: Check if docker exists
      stat:
        path: /usr/local/bin/docker
      register: docker

    - name: Setup for docker installation
      block:
        - name: Install required system packages for docker 
          package:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present

        - name: Add Docker GPG apt Key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker Repository
          apt_repository:
            repo: deb https://download.docker.com/linux/ubuntu bionic stable
            state: present

        - name: Install docker-ce
          package:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: latest
            update_cache: yes

        - name: Add docker group
          group:
            name: docker
            state: present
        
        - name: "Add \"{{ lookup('env', 'USER') }}\" to the docker group"
          shell:
            cmd: "usermod -aG docker {{ lookup('env', 'USER') }}"
      become: yes
      when: not docker.stat.exists
